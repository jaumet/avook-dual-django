{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h1>Perfil d'usuari</h1>
    <hr>
    <form method="post">
        {% csrf_token %}

        <div class="form-group">
            <label for="id_first_name">Nom:</label>
            {{ form.first_name }}
        </div>

        <div class="form-group">
            <label for="id_last_name">Cognoms:</label>
            {{ form.last_name }}
        </div>

        <div class="form-group">
            <label for="id_email">Email:</label>
            {{ form.email }}
        </div>

        <hr>

        <h2>Quines llengües saps?</h2>
        <div id="known-languages-container">
            <!-- Dynamic language fields will be inserted here -->
        </div>
        <button type="button" class="btn btn-secondary" id="add-known-language">Afegir llengua</button>

        <hr>

        <h2>Quines llengües vols aprendre?</h2>
        <div id="learning-languages-container">
            <!-- Dynamic language fields will be inserted here -->
        </div>
        <button type="button" class="btn btn-secondary" id="add-learning-language">Afegir llengua</button>

        {{ form.known_languages }}
        {{ form.learning_languages }}

        <hr>

        <button type="submit" class="btn btn-primary">Guardar canvis</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const languageLevels = ['A0', 'A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
    let languages = [];

    // Fetch language list
    fetch("{% static 'js/languages.json' %}")
        .then(response => response.json())
        .then(data => {
            languages = data.Lang_list;
            populateInitialData();
            setupEventListeners();
        });

    function createLanguageRow(container, language = '', level = 'A0') {
        const row = document.createElement('div');
        row.classList.add('language-row', 'form-row', 'mb-2');

        const langGroup = document.createElement('div');
        langGroup.classList.add('col');
        const langInput = document.createElement('input');
        langInput.type = 'text';
        langInput.name = 'language';
        langInput.value = language;
        langInput.classList.add('form-control');
        langInput.setAttribute('list', 'languages-datalist');
        langGroup.appendChild(langInput);

        const levelGroup = document.createElement('div');
        levelGroup.classList.add('col');
        const levelSelect = document.createElement('select');
        levelSelect.name = 'level';
        levelSelect.classList.add('form-control');
        languageLevels.forEach(lvl => {
            const option = document.createElement('option');
            option.value = lvl;
            option.textContent = lvl;
            if (lvl === level) {
                option.selected = true;
            }
            levelSelect.appendChild(option);
        });
        levelGroup.appendChild(levelSelect);

        const removeGroup = document.createElement('div');
        removeGroup.classList.add('col-auto');
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.textContent = 'Eliminar';
        removeButton.classList.add('btn', 'btn-danger');
        removeButton.addEventListener('click', () => row.remove());
        removeGroup.appendChild(removeButton);

        row.appendChild(langGroup);
        row.appendChild(levelGroup);
        row.appendChild(removeGroup);
        container.appendChild(row);
    }

    function populateInitialData() {
        const knownLanguages = {{ user.known_languages|safe }};
        const learningLanguages = {{ user.learning_languages|safe }};
        const knownContainer = document.getElementById('known-languages-container');
        const learningContainer = document.getElementById('learning-languages-container');

        knownLanguages.forEach(lang => createLanguageRow(knownContainer, lang.language, lang.level));
        learningLanguages.forEach(lang => createLanguageRow(learningContainer, lang.language, lang.level));

        const datalist = document.createElement('datalist');
        datalist.id = 'languages-datalist';
        languages.forEach(lang => {
            const option = document.createElement('option');
            option.value = lang.nom;
            datalist.appendChild(option);
        });
        document.body.appendChild(datalist);
    }

    function setupEventListeners() {
        document.getElementById('add-known-language').addEventListener('click', () => {
            createLanguageRow(document.getElementById('known-languages-container'));
        });

        document.getElementById('add-learning-language').addEventListener('click', () => {
            createLanguageRow(document.getElementById('learning-languages-container'));
        });

        const form = document.querySelector('form');
        form.addEventListener('submit', function(event) {
            const knownData = Array.from(document.querySelectorAll('#known-languages-container .language-row')).map(row => ({
                language: row.querySelector('input[name="language"]').value,
                level: row.querySelector('select[name="level"]').value
            }));
            const learningData = Array.from(document.querySelectorAll('#learning-languages-container .language-row')).map(row => ({
                language: row.querySelector('input[name="language"]').value,
                level: row.querySelector('select[name="level"]').value
            }));

            document.querySelector('input[name="known_languages"]').value = JSON.stringify(knownData);
            document.querySelector('input[name="learning_languages"]').value = JSON.stringify(learningData);
        });
    }
});
</script>
{% endblock %}
