<!DOCTYPE html>
{% load static %}
{% load i18n %}
{% load content_tags %}
<html lang="ca">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}dual.cat{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    <link rel="stylesheet" href="{% static 'css/forms.css' %}">
    <link rel="stylesheet" href="{% static 'css/tooltip.css' %}">
    <link rel="stylesheet" href="{% static 'css/ribbons.css' %}">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="dual.cat">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="{% static 'imgs/dual-cats.gif' %}">
    {% block extra_css %}{% endblock %}

<!-------------------->
<style>
  :root {
    --dual-blue: #0d0e37;
    --dual-orange: #f7836a;
  }

  #dual-gate {
    position: fixed;
    inset: 0;
    background: var(--dual-blue);
    color: var(--dual-orange);

    /* Layout accessible */
    display: flex;
    flex-direction: column;
    align-items: center;

    padding: 1.5rem 1rem;
    overflow-y: auto;

    z-index: 99999;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    text-align: center;
  }

  #dual-gate img {
    max-width: min(220px, 60vw);
    height: auto;
    margin: 1rem 0 1.5rem;
    flex-shrink: 0;
  }

  #dual-gate h1 {
    font-size: clamp(1.6rem, 6vw, 2.4rem);
    margin: 0 0 0.75rem;
    font-weight: 700;
  }

  #dual-gate h2 {
    font-size: clamp(1rem, 4.5vw, 1.4rem);
    line-height: 1.4;
    margin: 0 0 2rem;
    font-weight: 500;
  }

  #dual-gate button {
    background: var(--dual-orange);
    color: var(--dual-blue);
    border: none;
    padding: 0.75rem 1.8rem;
    font-size: clamp(1rem, 4vw, 1.1rem);
    cursor: pointer;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    flex-shrink: 0;
  }

  #dual-gate button:hover {
    opacity: 0.9;
  }
</style>


<div id="dual-gate">
  <img src="/static/imgs/dual-cats.gif" alt="Dual logo">
  <h1>dual.cat</h1>
  <h2>
    Properament <br>
    Coming soon <br>
    Pr√≥ximamente <br>
    Bald verf√ºgbar <br>
    Prochainement <br>
    Prossimamente <br>
    Em breve 
  </h2>

  <button id="dual-login-btn">Log in</button>
</div>

<script>
(function () {
  const PASSWORD = "g0t0dem0";
  const KEY = "dual_demo_ok";

  // Si ja estem dins la sessi√≥, amaguem el gate
  if (sessionStorage.getItem(KEY) === "1") {
    const gate = document.getElementById("dual-gate");
    if (gate) gate.remove();
    return;
  }

  document.getElementById("dual-login-btn").onclick = function () {
    const entered = prompt("Contrasenya:");

    if (entered === PASSWORD) {
      sessionStorage.setItem(KEY, "1");
      document.getElementById("dual-gate").remove();
    } else {
      alert("Contrasenya incorrecta");
    }
  };
})();
</script>


<!---------------------->

</head>
<body>
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.classList.add('light');
            }
        })();
    </script>
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/translator.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const langSelect = document.getElementById('language-select');
            const currentLang = window.location.pathname.split('/')[1] || 'ca';

            // Set the dropdown to the current language
            langSelect.value = currentLang;

            langSelect.addEventListener('change', (event) => {
                const newLang = event.target.value;
                const pathParts = window.location.pathname.split('/');

                // Replace the language part of the URL, or add it if it's not there
                if (pathParts.length > 1 && ['ca', 'en', 'es', 'fr', 'de', 'it', 'pt'].includes(pathParts[1])) {
                    pathParts[1] = newLang;
                } else {
                    pathParts.splice(1, 0, newLang);
                }

                window.location.pathname = pathParts.join('/');
            });
        });
    </script>
    <script src="{% static 'js/theme_switcher.js' %}"></script>
    {% block extra_js %}{% endblock %}
<header class="main-header">
    <div class="header-left">
        <a href="{% url 'home' %}" class="logo-link">
            <img src="{% static 'imgs/dual-cats.gif' %}" alt="Dual.cat" class="logo" />
            <div class="logo-text-container">
                <span class="logo-text">Dual</span>
                <span class="logo-subtitle">dual.cat</span>
            </div>
        </a>
    </div>
    <button id="menuToggle" class="menu-toggle" aria-label="Toggle navigation">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
    </button>
    <nav class="header-right">
        <a href="{% url 'products:catalog' %}" data-translate-key="header.catalog">Cat√†leg</a>
        <a href="{% url 'products:product_list' %}" data-translate-key="header.products">Productes</a>
        {% if user.is_authenticated %}
            <div class="user-menu">
                <a href="#" class="user-menu-trigger">{% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}</a>
                <div class="user-menu-dropdown">
                    <a href="{% url 'accounts:profile' %}" data-translate-key="header.profile">Perfil</a>
                    <a href="{% url 'accounts:purchase_history' %}">{% trans "My products" %}</a>
                    <a href="{% url 'accounts:activity' %}" data-translate-key="header.activity_log">Activity Log</a>
                    {% if user.is_staff %}
                        <a href="{% url 'products:product_create' %}" data-translate-key="header.add_product">Afegir producte</a>
                    {% endif %}
                    <form action="{% url 'account_logout' %}" method="post" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="button-link" data-translate-key="header.logout">Tanca sessi√≥</button>
                    </form>
                </div>
            </div>
        {% else %}
            <a href="{% url 'account_login' %}" data-translate-key="header.login">Inicia sessi√≥</a>
            <a href="{% url 'account_signup' %}" class="button button--small" data-translate-key="header.signup">Registra't</a>
        {% endif %}
        <div class="rightBtns">
            <button id="pwaInstallBtn">üì≤ <span data-translate-key="header.install">Instal¬∑la</span></button>
            <button id="themeBtn">‚òÄÔ∏è <span data-translate-key="header.theme.light">Clar</span></button>
            <button id="infoBtn">‚ùì <span data-translate-key="header.help">Ajuda</span></button>
        </div>

        <div class="language-switcher">
            <select id="language-select">
                <option value="ca">Catal√†</option>
                <option value="en">English</option>
                <option value="es">Espa√±ol</option>
                <option value="fr">Fran√ßais</option>
                <option value="de">Deutsch</option>
                <option value="it">Italiano</option>
                <option value="pt">Portugu√™s</option>
            </select>
        </div>
    </nav>
</header>

<main>
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message message--{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
    {% block content %}{% endblock %}
</main>

{% include 'footer.html' %}

<!-- Modal ajuda -->
<div id="infoModal">
  <div id="infoContent">
    <div id="help-modal-content-placeholder">{% get_translatable_content 'help_modal_html_content'|safe %}</div>
    <button id="closeModal" data-translate-key="help_modal.close">Tanca</button>
  </div>
</div>

<script>
    // PWA Installation Logic - Always included, not overridable by blocks
    (function() {
        let deferredPrompt;

        const showInstallButton = () => {
            const btn = document.getElementById('pwaInstallBtn');
            if (btn) btn.style.display = 'inline-block';
        };

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', showInstallButton);
            } else {
                showInstallButton();
            }
        });

        const isIos = () => {
            const userAgent = window.navigator.userAgent.toLowerCase();
            return /iphone|ipad|ipod/.test(userAgent) ||
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        };

        const isInStandaloneMode = () =>
            (('standalone' in window.navigator) && (window.navigator.standalone)) ||
            (window.matchMedia('(display-mode: standalone)').matches);

        document.addEventListener('DOMContentLoaded', () => {
            const pwaInstallBtn = document.getElementById('pwaInstallBtn');
            if (!pwaInstallBtn) return;

            // Always try to show the button if not already in standalone mode
            if (!isInStandaloneMode()) {
                showInstallButton();
            }

            pwaInstallBtn.addEventListener('click', (e) => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            pwaInstallBtn.style.display = 'none';
                        }
                        deferredPrompt = null;
                    });
                } else if (isIos()) {
                    alert(`{% trans "Per instal¬∑lar aquesta aplicaci√≥ al teu dispositiu: prem el bot√≥ de compartir i despr√©s 'Afegeix a la pantalla d'inici'" %}`);
                } else {
                    alert(`{% trans "Per instal¬∑lar aquesta aplicaci√≥: busca l'opci√≥ 'Instal¬∑la' o 'Afegeix a la pantalla d'inici' al men√∫ del teu navegador." %}`);
                }
            });
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    console.log('SW registered');
                }).catch(err => {
                    console.log('SW registration failed:', err);
                });
            });
        }
    })();
</script>
</body>
</html>
