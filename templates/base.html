{% load static %}
{% load content_tags %}
{% load cart_tags %}
<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}dual.cat{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    <link rel="stylesheet" href="{% static 'css/forms.css' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/translator.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const langSelect = document.getElementById('language-select');
            const currentLang = window.location.pathname.split('/')[1] || 'ca';

            // Set the dropdown to the current language
            langSelect.value = currentLang;

            langSelect.addEventListener('change', (event) => {
                const newLang = event.target.value;
                const pathParts = window.location.pathname.split('/');

                // Replace the language part of the URL, or add it if it's not there
                if (pathParts.length > 1 && ['ca', 'en', 'es', 'fr', 'it', 'pt'].includes(pathParts[1])) {
                    pathParts[1] = newLang;
                } else {
                    pathParts.splice(1, 0, newLang);
                }

                window.location.pathname = pathParts.join('/');
            });
        });
    </script>
    {% block extra_js %}
        <script src="{% static 'js/theme_switcher.js' %}"></script>
    {% endblock %}
<header class="main-header">
    <div class="header-left">
        <a href="{% url 'home' %}" class="logo-link">
            <img src="{% static 'imgs/logo-dual-fons-blau.png' %}" alt="dual.cat" class="logo" />
            <div class="logo-text-container">
                <span class="logo-text">Dual</span>
                <span class="logo-subtitle">dual.cat</span>
            </div>
        </a>
    </div>
    <nav class="header-right">
        <a href="{% url 'products:catalog' %}" data-translate-key="header.catalog">Catàleg</a>
        <a href="{% url 'products:product_list' %}" data-translate-key="header.products">Productes</a>
        <a href="{% url 'products:cart' %}" class="cart-link">
            <svg class="cart-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.21 9l-4.38-6.56a.993.993 0 0 0-.81-.44H7.98c-.45 0-.85.3-.98.73L2.25 12l-1.02 2.03c-.2.4.18.9.6.9h19.54c.41 0 .79-.49.59-.9L21 12l-3.79-3zM7 16c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM4.33 13l2.84-5.67.63 2.67H16.2l.63-2.67L19.67 13H4.33z"/></svg>
            <span class="cart-count">{% cart_item_count %}</span>
        </a>
        {% if user.is_authenticated %}
            <div class="user-menu">
                <a href="#" class="user-menu-trigger">{% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}</a>
                <div class="user-menu-dropdown">
                    <a href="{% url 'accounts:profile' %}" data-translate-key="header.profile">Perfil</a>
                    <a href="{% url 'accounts:library' %}" data-translate-key="header.my_library">La meva llibreria</a>
                    {% if user.is_staff %}
                        <a href="{% url 'products:product_create' %}" data-translate-key="header.add_product">Afegir producte</a>
                        <a href="{% url 'products:title_create' %}" data-translate-key="header.add_title">Afegir títol</a>
                    {% endif %}
                    <form action="{% url 'accounts:logout' %}" method="post" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="button-link" data-translate-key="header.logout">Tanca sessió</button>
                    </form>
                </div>
            </div>
        {% else %}
            <a href="{% url 'accounts:login' %}" data-translate-key="header.login">Inicia sessió</a>
            <a href="{% url 'signup' %}" class="button button--small" data-translate-key="header.signup">Registra't</a>
        {% endif %}
        <div class="rightBtns">
            <button id="themeBtn">☀️ <span data-translate-key="header.theme.light">Clar</span></button>
            <button id="infoBtn">❓ <span data-translate-key="header.help">Ajuda</span></button>
        </div>

        <div class="language-switcher">
            <select id="language-select">
                <option value="ca">Català</option>
                <option value="en">English</option>
                <option value="es">Español</option>
                <option value="fr">Français</option>
                <option value="it">Italiano</option>
                <option value="pt">Português</option>
            </select>
        </div>
    </nav>
</header>

<main>
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message message--{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
    {% block content %}{% endblock %}
</main>

{% include 'footer.html' %}

<!-- Modal ajuda -->
<div id="infoModal">
  <div id="infoContent">
    <div id="help-modal-content-placeholder">{% get_translatable_content 'help_modal_html_content'|safe %}</div>
    <button id="closeModal" data-translate-key="help_modal.close">Tanca</button>
  </div>
</div>
</body>
</html>
