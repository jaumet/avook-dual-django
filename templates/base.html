<!DOCTYPE html>
{% load static %}
{% load i18n %}
{% load content_tags %}
<html lang="ca">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}dual.cat{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
    <link rel="stylesheet" href="{% static 'css/forms.css' %}">
    <link rel="stylesheet" href="{% static 'css/tooltip.css' %}">
    <link rel="stylesheet" href="{% static 'css/ribbons.css' %}">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="dual.cat">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="{% static 'imgs/logo-dual-fons-blau.png' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/translator.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const langSelect = document.getElementById('language-select');
            const currentLang = window.location.pathname.split('/')[1] || 'ca';

            // Set the dropdown to the current language
            langSelect.value = currentLang;

            langSelect.addEventListener('change', (event) => {
                const newLang = event.target.value;
                const pathParts = window.location.pathname.split('/');

                // Replace the language part of the URL, or add it if it's not there
                if (pathParts.length > 1 && ['ca', 'en', 'es', 'fr', 'de', 'it', 'pt'].includes(pathParts[1])) {
                    pathParts[1] = newLang;
                } else {
                    pathParts.splice(1, 0, newLang);
                }

                window.location.pathname = pathParts.join('/');
            });
        });
    </script>
    {% block extra_js %}
        <script src="{% static 'js/theme_switcher.js' %}"></script>
    {% endblock %}
<header class="main-header">
    <div class="header-left" style="display: flex; align-items: center; gap: 1em;">
        <a href="https://dual.cat">
            <img src="{% static 'img/dual-logo.svg' %}" alt="Dual.cat" style="height: 40px; width: auto;" />
        </a>
        <a href="{% url 'home' %}" class="logo-link">
            <img src="{% static 'imgs/logo-dual-fons-blau.png' %}" alt="dual.cat" class="logo" />
            <div class="logo-text-container">
                <span class="logo-text">Dual</span>
                <span class="logo-subtitle">dual.cat</span>
            </div>
        </a>
    </div>
    <nav class="header-right">
        <a href="{% url 'products:catalog' %}" data-translate-key="header.catalog">Cat√†leg</a>
        <a href="{% url 'products:product_list' %}" data-translate-key="header.products">Productes</a>
        {% if user.is_authenticated %}
            <div class="user-menu">
                <a href="#" class="user-menu-trigger">{% if user.first_name %}{{ user.first_name }}{% else %}{{ user.username }}{% endif %}</a>
                <div class="user-menu-dropdown">
                    <a href="{% url 'accounts:profile' %}" data-translate-key="header.profile">Perfil</a>
                    <a href="{% url 'accounts:purchase_history' %}">{% trans "My products" %}</a>
                    <a href="{% url 'accounts:activity' %}" data-translate-key="header.activity_log">Activity Log</a>
                    {% if user.is_staff %}
                        <a href="{% url 'products:product_create' %}" data-translate-key="header.add_product">Afegir producte</a>
                    {% endif %}
                    <form action="{% url 'accounts:logout' %}" method="post" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="button-link" data-translate-key="header.logout">Tanca sessi√≥</button>
                    </form>
                </div>
            </div>
        {% else %}
            <a href="{% url 'accounts:login' %}" data-translate-key="header.login">Inicia sessi√≥</a>
            <a href="{% url 'accounts:signup' %}" class="button button--small" data-translate-key="header.signup">Registra't</a>
        {% endif %}
        <div class="rightBtns">
            <button id="pwaInstallBtn">üì≤ <span data-translate-key="header.install">Instal¬∑la</span></button>
            <button id="themeBtn">‚òÄÔ∏è <span data-translate-key="header.theme.light">Clar</span></button>
            <button id="infoBtn">‚ùì <span data-translate-key="header.help">Ajuda</span></button>
        </div>

        <div class="language-switcher">
            <select id="language-select">
                <option value="ca">Catal√†</option>
                <option value="en">English</option>
                <option value="es">Espa√±ol</option>
                <option value="fr">Fran√ßais</option>
                <option value="de">Deutsch</option>
                <option value="it">Italiano</option>
                <option value="pt">Portugu√™s</option>
            </select>
        </div>
    </nav>
</header>

<main>
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message message--{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
    {% block content %}{% endblock %}
</main>

{% include 'footer.html' %}

<!-- Modal ajuda -->
<div id="infoModal">
  <div id="infoContent">
    <div id="help-modal-content-placeholder">{% get_translatable_content 'help_modal_html_content'|safe %}</div>
    <button id="closeModal" data-translate-key="help_modal.close">Tanca</button>
  </div>
</div>

<script>
    // PWA Installation Logic - Always included, not overridable by blocks
    (function() {
        let deferredPrompt;

        const showInstallButton = () => {
            const btn = document.getElementById('pwaInstallBtn');
            if (btn) btn.style.display = 'inline-block';
        };

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', showInstallButton);
            } else {
                showInstallButton();
            }
        });

        const isIos = () => {
            const userAgent = window.navigator.userAgent.toLowerCase();
            return /iphone|ipad|ipod/.test(userAgent) ||
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        };

        const isInStandaloneMode = () =>
            (('standalone' in window.navigator) && (window.navigator.standalone)) ||
            (window.matchMedia('(display-mode: standalone)').matches);

        document.addEventListener('DOMContentLoaded', () => {
            const pwaInstallBtn = document.getElementById('pwaInstallBtn');
            if (!pwaInstallBtn) return;

            // Always try to show the button if not already in standalone mode
            if (!isInStandaloneMode()) {
                showInstallButton();
            }

            pwaInstallBtn.addEventListener('click', (e) => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            pwaInstallBtn.style.display = 'none';
                        }
                        deferredPrompt = null;
                    });
                } else if (isIos()) {
                    alert(`{% trans "Per instal¬∑lar aquesta aplicaci√≥ al teu dispositiu: prem el bot√≥ de compartir i despr√©s 'Afegeix a la pantalla d'inici'" %}`);
                } else {
                    alert(`{% trans "Per instal¬∑lar aquesta aplicaci√≥: busca l'opci√≥ 'Instal¬∑la' o 'Afegeix a la pantalla d'inici' al men√∫ del teu navegador." %}`);
                }
            });
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(reg => {
                    console.log('SW registered');
                }).catch(err => {
                    console.log('SW registration failed:', err);
                });
            });
        }
    })();
</script>
</body>
</html>
