{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/catalog_filters.css' %}">
    <link rel="stylesheet" href="{% static 'css/title_card.css' %}">
{% endblock %}

{% block content %}
<main class="container">
    <div class="product-header">
        <h1>{% trans "Tests for" %} {{ product.translation.name }}</h1>
        <p>{{ product.translation.description|safe }}</p>
    </div>

    <!-- Level filters -->
    <div class="level-filters">
        <span>{% trans "Filter by level:" %}</span>
        {% for level in levels %}
            <label class="level-filter">
                <input type="checkbox" name="level" value="{{ level }}" checked> {{ level }}
            </label>
        {% endfor %}
    </div>

    <section id="catalog" class="title-cards-container">
        {% for level, items in titles_by_level.items %}
            <h2 class="level-heading" data-level="{{ level }}">{{ level }}</h2>
            {% for item in items %}
                {% include 'products/_title_card.html' with item=item %}
            {% endfor %}
        {% empty %}
            <p>{% trans "No tests available for this product." %}</p>
        {% endfor %}
    </section>
    <p id="noResultsMessage" style="display: none;">{% trans "No results found for your search." %}</p>
</main>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const levelFilters = document.querySelectorAll('.level-filter input[type="checkbox"]');
    const levelContainers = document.querySelectorAll('.level-container');
    const levelHeadings = document.querySelectorAll('.level-heading');
    const noResultsMessage = document.getElementById('noResultsMessage');

    function filterLevels() {
        const checkedLevels = Array.from(levelFilters)
            .filter(input => input.checked)
            .map(input => input.value);

        let totalVisibleContainers = 0;

        levelHeadings.forEach(heading => {
            const level = heading.dataset.level;
            const containersForLevel = document.querySelectorAll(`.level-container[data-level="${level}"]`);
            let visibleInLevel = 0;

            containersForLevel.forEach(container => {
                if (checkedLevels.includes(level)) {
                    container.style.display = 'block';
                    visibleInLevel++;
                } else {
                    container.style.display = 'none';
                }
            });

            if (visibleInLevel > 0) {
                heading.style.display = 'block';
                totalVisibleContainers += visibleInLevel;
            } else {
                heading.style.display = 'none';
            }
        });

        if (totalVisibleContainers === 0) {
            noResultsMessage.style.display = 'block';
        } else {
            noResultsMessage.style.display = 'none';
        }
    }

    levelFilters.forEach(input => {
        input.addEventListener('change', filterLevels);
    });

    // Initial filter on page load
    filterLevels();
});
</script>
{% endblock %}
