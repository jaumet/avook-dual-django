{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/catalog_filters.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom_title_card.css' %}">
{% endblock %}

{% block content %}
<main class="container">
    <div class="product-header">
        <h1>{% trans "Tests for" %} {{ product.translation.name }}</h1>
        <p>{{ product.translation.description|safe }}</p>
    </div>

    <!-- Level filters -->
    <div class="level-filters">
        <span>{% trans "Filter by level:" %}</span>
        {% for level in levels %}
            <label class="level-filter">
                <input type="checkbox" name="level" value="{{ level }}" checked> {{ level }}
            </label>
        {% endfor %}
    </div>

    <section id="catalog">
        {% for level, items in titles_by_level.items %}
            <div class="level-container">
                <h2 class="level-heading" data-level="{{ level }}">{{ level }}</h2>
                <div class="title-grid">
                    {% for item in items %}
                        {% include 'products/_title_card.html' with item=item %}
                    {% endfor %}
                </div>
            </div>
        {% empty %}
            <p>{% trans "No tests available for this product." %}</p>
        {% endfor %}
    </section>
    <p id="noResultsMessage" style="display: none;">{% trans "No results found for your search." %}</p>
</main>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const levelFilters = document.querySelectorAll('.level-filter input[type="checkbox"]');
    const titleCards = document.querySelectorAll('.custom-title-card');
    const levelHeadings = document.querySelectorAll('.level-heading');
    const noResultsMessage = document.getElementById('noResultsMessage');

    function filterContent() {
        const checkedLevels = Array.from(levelFilters)
            .filter(input => input.checked)
            .map(input => input.value);

        titleCards.forEach(card => {
            const cardLevel = card.getAttribute('data-level');
            if (checkedLevels.includes(cardLevel)) {
                card.style.display = 'flex';
            } else {
                card.style.display = 'none';
            }
        });

        levelHeadings.forEach(heading => {
            const headingLevel = heading.getAttribute('data-level');
            const correspondingCards = document.querySelectorAll(`.custom-title-card[data-level="${headingLevel}"]`);
            const anyVisible = Array.from(correspondingCards).some(card => card.style.display !== 'none');

            if (anyVisible) {
                heading.style.display = 'block';
                heading.parentElement.style.display = 'block';
            } else {
                heading.style.display = 'none';
                heading.parentElement.style.display = 'none';
            }
        });

        const anyCardVisible = Array.from(titleCards).some(card => card.style.display !== 'none');
        if (!anyCardVisible) {
            noResultsMessage.style.display = 'block';
        } else {
            noResultsMessage.style.display = 'none';
        }
    }

    levelFilters.forEach(input => {
        input.addEventListener('change', filterContent);
    });

    // Initial filter on page load
    filterContent();
});
</script>
{% endblock %}
