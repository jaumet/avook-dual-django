{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
  :root{
    --bg:#0d0e37;
    --fg:#f5f5f7;
    --panel-bg:#18194a;
    --panel-fg:#fff;
    --accent:#f7836a;
    --header-bg:#0d0e37;
  }
  body.light{
    --bg:#f5f5f7;
    --fg:#222;
    --panel-bg:#fff;
    --panel-fg:#222;
    --accent:#0d0e37;
    --header-bg:#0d0e37;
  }
  body{
    font-family:"DejaVu Sans",system-ui,sans-serif;
    background:var(--bg);color:var(--fg);margin:0;
    transition:background .3s,color .3s;
  }
  header{
    background:var(--header-bg);color:#fff;
    display:flex;align-items:center;justify-content:space-between;
    padding:.8em 1em;
  }
  header a{display:flex;align-items:center;gap:.6em;text-decoration:none;color:inherit}
  header img{height:40px}
  header h1{margin:0;font-size:1.2em;color:#fff}
  header .rightBtns{display:flex;align-items:center;gap:.6em}
  header button{background:#fff;color:var(--accent);border:0;border-radius:6px;padding:.4em .8em;cursor:pointer;font-weight:bold;}
  header button:hover{opacity:.9}

  main{max-width:980px;margin:0 auto;padding:1.2em}
  .topCard{display:flex;gap:1em;align-items:center;background:var(--panel-bg);
    border:4px solid var(--accent);border-radius:10px;padding:1em;margin-bottom:1em;color:var(--panel-fg);}
  .topCard img{width:auto;max-height:80px;border-radius:6px;object-fit:contain}
  .topCard h2{margin:.1em 0 .2em 0;color:var(--panel-fg)}
  .topCard .langs{font-weight:bold;color:var(--panel-fg)}

  .panel-soft{background:var(--panel-bg);color:var(--panel-fg);
    border:none;border-radius:10px;padding:1em;margin:.6em 0}
  .row{display:flex;flex-wrap:wrap;gap:1em;align-items:flex-start}
  .langBox{flex:1 1 320px;background:var(--panel-bg);color:var(--panel-fg);
    border:4px solid var(--accent);border-radius:10px;padding:1em}
  .radios{display:flex;gap:.8em;flex-wrap:wrap}
  .radios label{display:flex;align-items:center;gap:.3em;border:2px solid var(--accent);
    border-radius:20px;padding:.2em .6em;background:var(--fg);color:var(--bg);cursor:pointer}
  select{font-size:1em;border:2px solid var(--accent);border-radius:6px;padding:.2em .4em;background:var(--panel-bg);color:var(--panel-fg)}

  #modesPanel{text-align:center;margin:1em 0;}
  #modesPanel>div:first-child{font-weight:bold;color:var(--accent);margin-bottom:.4em;}
  #modeButtons{display:flex;flex-wrap:wrap;justify-content:center;gap:.6em;}
  #modeButtons button{
    background:var(--accent);color:#fff;border:0;border-radius:10px;
    font-size:1.05em;padding:.6em 1.2em;cursor:pointer;
    transition:background .2s,transform .1s;
  }
  #modeButtons button:hover{background:#191a5b;transform:scale(1.05);}

  #textBox{position:relative;border:2px solid var(--accent);border-radius:10px;
    background:var(--panel-bg);color:var(--panel-fg);padding:1em;
    margin:.6em 0;min-height:3.2em;font-size:1.05em;font-style:italic}
  #progressInfo{position:absolute;top:4px;right:8px;font-size:0.8em;color:#ccc;}
  #progressBarContainer{position:absolute;bottom:0;left:0;width:100%;height:8px;background:#8884;border-radius:0 0 10px 10px;overflow:hidden;}
  #progressBar{height:100%;width:0%;background:linear-gradient(90deg,#f7836a,#ffb27a);transition:width .3s;}
  audio{width:100%;margin-top:.6em}
  #backBtn{display:none;margin:1em auto 0 auto;border:0;background:var(--accent);
    color:#fff;border-radius:8px;padding:.6em 1em;cursor:pointer}
  #backBtn:hover{background:#191a5b}
  #playerPanel button{background:var(--accent);color:#fff;border:0;border-radius:8px;padding:.4em .8em;cursor:pointer}
  #playerPanel button:hover{background:#191a5b}

  #infoModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.6); z-index:999; align-items:center; justify-content:center; }
  #infoContent { background:var(--panel-bg); color:var(--panel-fg); border:2px solid var(--accent); border-radius:10px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; padding:1.4em; box-shadow:0 4px 12px rgba(0,0,0,.5); scrollbar-color:var(--accent) var(--panel-bg); scrollbar-width:thin; }
  #closeModal { background:var(--accent); color:#fff; border:0; border-radius:6px; padding:.4em .8em; cursor:pointer; margin-top:.8em; }
  #infoContent ul { padding-left:1.4em; line-height:1.5; }
  #infoContent h4 { margin-top:1em; color:var(--accent); }

  #textContent {
    text-align: center;
    font-weight: bold;
    font-size: 1.1em;
    line-height: 1.6;
    margin: 1em 0;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const qs = s => document.querySelector(s);
    const qsa = s => [...document.querySelectorAll(s)];
    const iso2to3 = c => ({ CA: 'cat', EN: 'eng', PT: 'por', FR: 'fra', IT: 'ita', ES: 'spa' })[c] || c.toLowerCase();

    const availableLangs = [{% for lang in languages %}"{{ lang.language }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
    let langData = {};
    let sequence = [];
    let seqIndex = 0;
    const audioEl = qs('#audio');

    function radiosMarkup(langs, name, checked) {
        return langs.map(L => `<label><input type="radio" name="${name}" value="${L}" ${checked ? 'checked' : ''}/> ${iso2to3(L)}</label>`).join('');
    }

    function getL1() {
        return qs('input[name="l1"]:checked')?.value || null;
    }

    function getL2() {
        return qs('input[name="l2"]:checked')?.value || null;
    }

    function updateProgress() {
        const total = sequence.length || 0;
        const current = Math.min(seqIndex + 1, total);
        const percent = total ? Math.round((current / total) * 100) : 0;
        qs('#progressInfo').textContent = `${current} / ${total} ‚Äî ${percent}%`;
        qs('#progressBar').style.width = percent + '%';
    }

    function playNext(manual = false) {
        if (seqIndex >= sequence.length) {
            if (!qs('#textContent').textContent.includes('Finalitzat')) {
                qs('#textContent').innerHTML += ' ‚úÖ Finalitzat.';
            }
            updateProgress();
            audioEl.src = '';
            return;
        }
        const item = sequence[seqIndex];
        qs('#textContent').textContent = item.text || '‚Äî';
        const L1 = getL1();
        const spd1 = parseFloat(qs('#speed1').value);
        const spd2 = parseFloat(qs('#speed2').value);
        const spd = item.lang === L1 ? spd1 : spd2;
        const src = `/static/AUDIOS/{{ title.machine_name }}/${item.lang}/${item.file.replace(/^\.?\/*/,'')}`;
        audioEl.src = src;
        audioEl.playbackRate = spd;
        if (!manual) audioEl.play().catch(() => {});
        audioEl.onended = () => {
            seqIndex++;
            playNext();
        };
        updateProgress();
    }

    function playPrev() {
        if (seqIndex > 0) {
            seqIndex--;
            playNext(true);
        }
    }

    function playNextManual() {
        if (seqIndex < sequence.length - 1) {
            seqIndex++;
            playNext(true);
        }
    }

    async function startMode(mode) {
        const langs = mode.includes('-') ? mode.split('-') : [mode];
        for (const L of langs) {
            if (!langData[L]) {
                const path = `/static/AUDIOS/{{ title.machine_name }}/${L}-{{ title.machine_name }}.json`;
                try {
                    const r = await fetch(path);
                    if (r.ok) {
                        langData[L] = await r.json();
                    } else {
                        langData[L] = [];
                    }
                } catch (error) {
                    console.error('Error fetching JSON:', error);
                    langData[L] = [];
                }
            }
        }
        sequence = [];
        if (mode.includes('-')) {
            const [A, B] = mode.split('-');
            const len = Math.max(langData[A].length, langData[B].length);
            for (let i = 0; i < len; i++) {
                if (langData[A][i]) sequence.push({ ...langData[A][i],
                    lang: A
                });
                if (langData[B][i]) sequence.push({ ...langData[B][i],
                    lang: B
                });
            }
        } else {
            sequence = langData[mode].map(x => ({ ...x,
                lang: mode
            }));
        }
        seqIndex = 0;
        playNext();
    }

    function buildModes() {
        const L1 = getL1();
        const L2 = getL2();
        const buttons = [];
        if (L1) buttons.push(L1);
        if (L1 && L2 && L2 !== '' && L2 !== L1) {
            buttons.push(`${L1}-${L2}`, `${L2}-${L1}`, L2);
        }
        const modeButtons = qs('#modeButtons');
        const titleEl = qs('#modesTitle');
        modeButtons.innerHTML = buttons.map(m => `<button data-mode="${m}">${m}</button>`).join('');
        titleEl.style.display = buttons.length > 1 ? 'block' : 'none';
        qsa('#modeButtons button').forEach(b => b.onclick = () => startMode(b.dataset.mode));
    }

    function disableSameLang() {
        const l1 = getL1();
        qsa('input[name="l2"]').forEach(r => {
            r.disabled = (r.value && r.value === l1);
            if (r.checked && r.disabled) {
                const none = qs('input[name="l2"][value=""]');
                if (none) none.checked = true;
            }
        });
        buildModes();
    }

    function buildLangRadios() {
        const L1 = radiosMarkup(availableLangs, 'l1', false);
        const L2 = `<label><input type="radio" name="l2" value="" checked> cap</label>` + radiosMarkup(availableLangs, 'l2', false);
        qs('#radiosL1').innerHTML = L1;
        qs('#radiosL2').innerHTML = L2;

        qsa('input[name="l1"]').forEach(r => r.onchange = disableSameLang);
        qsa('input[name="l2"]').forEach(r => r.onchange = buildModes);

        disableSameLang();
    }

    buildLangRadios();

    qs('#prevBtn').onclick = () => playPrev();
    qs('#nextBtn').onclick = () => playNextManual();
});
</script>
{% endblock %}

{% block content %}
<main>
  <section id="topInfo" class="topCard">
    <img id="relatImg" src="{% static 'imgs/book-icon.png' %}" alt="Imatge relat"/>
    <div>
      <h2 id="relatTitle">{{ title.human_name }}</h2>
      <div id="relatDesc" style="margin:.1em 0 .3em 0;">{{ title.description }}</div>
      <div class="langs">üåê Idiomes: <span id="relatLangs">
        {% for lang in title.languages.all %}
          {{ lang.language }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      </span></div>
    </div>
  </section>

  <section id="setupPanel" class="panel-soft">
    <div class="row">
      <div class="langBox">
        <strong>Primera llengua</strong>
        <div id="radiosL1" class="radios"></div>
        <label style="margin-top:.6em">Velocitat 1:
          <select id="speed1"><option>0.5</option><option>0.7</option><option>0.8</option><option>0.9</option><option selected>1.0</option><option>1.1</option><option>1.2</option><option>1.5</option><option>2</option></select>
        </label>
      </div>
      <div class="langBox">
        <strong>Segona llengua (opcional)</strong>
        <div id="radiosL2" class="radios"></div>
        <label style="margin-top:.6em">Velocitat 2:
          <select id="speed2"><option>0.5</option><option>0.7</option><option>0.8</option><option>0.9</option><option selected>1.0</option><option>1.1</option><option>1.2</option><option>1.5</option><option>2</option></select>
        </label>
      </div>
    </div>
  </section>

  <section id="modesPanel" style="text-align:center;margin:1em 0;">
    <div id="modesTitle">üåê Modes d‚Äôescolta</div>
    <div id="modeButtons"></div>
  </section>

  <section id="playerPanel" class="panel">
    <div id="textBox">
      <div id="progressInfo"></div>
      <div id="textContent"></div>
      <div id="progressBarContainer"><div id="progressBar"></div></div>
    </div>
    <div style="display:flex;align-items:center;justify-content:center;gap:.8em;margin:.6em 0;">
      <button id="prevBtn">‚èÆÔ∏è</button>
      <audio id="audio" controls></audio>
      <button id="nextBtn">‚è≠Ô∏è</button>
    </div>
    <a id="backBtn" href="{% url 'products:catalog' %}" class="button">‚¨ÖÔ∏è Torna al cat√†leg</a>
  </section>
</main>
{% endblock %}
