{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/player.css' %}">
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const qs = s => document.querySelector(s);
    const qsa = s => [...document.querySelectorAll(s)];
    const iso2to3 = c => ({ CA: 'cat', EN: 'eng', PT: 'por', FR: 'fra', IT: 'ita', ES: 'spa' })[c] || c.toLowerCase();

    const availableLangs = [{% for lang in transcripts.keys %}"{{ lang }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
    let langData = {};
    let sequence = [];
    let seqIndex = 0;
    const audioEl = qs('#audio');
    let translations = {};

    let activityInterval;
    let secondsListened = 0;
    let currentMode = null;

    function logActivity(is_new_session = false) {
        if (!{{ request.user.is_authenticated|yesno:"true,false" }} || !currentMode) return;

        const total = sequence.length || 0;
        const percent = total ? Math.round((seqIndex / total) * 100) : 0;

        fetch(window.location.pathname, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                language_pair: currentMode,
                listening_time: secondsListened,
                completion_percentage: percent,
                is_new_session: is_new_session
            })
        }).then(() => {
            secondsListened = 0; // Reset after successful logging
        });
    }

    let listeningTimer;
    audioEl.addEventListener('play', () => {
        clearInterval(listeningTimer);
        listeningTimer = setInterval(() => {
            secondsListened++;
        }, 1000);
    });

    audioEl.addEventListener('pause', () => {
        clearInterval(listeningTimer);
    });

    audioEl.addEventListener('ended', () => {
        clearInterval(listeningTimer);
    });

    async function loadTranslations() {
        try {
            const response = await fetch('/static/js/translations.json');
            if (response.ok) {
                translations = await response.json();
            }
        } catch (error) {
            console.error('Error fetching translations:', error);
        }
    }

    function t(key) {
        const lang = window.location.pathname.split('/')[1] || 'ca';
        return translations[lang] && translations[lang][key] ? translations[lang][key] : key;
    }

    function radiosMarkup(langs, name, checked) {
        return langs.map(L => `<label><input type="radio" name="${name}" value="${L}" ${checked ? 'checked' : ''}/> ${iso2to3(L)}</label>`).join('');
    }

    function getL1() {
        return qs('input[name="l1"]:checked')?.value || null;
    }

    function getL2() {
        return qs('input[name="l2"]:checked')?.value || null;
    }

    function updateProgress() {
        const total = sequence.length || 0;
        const current = seqIndex;
        const percent = total ? Math.round((current / total) * 100) : 0;
        qs('#progressInfo').textContent = `${current} / ${total} ‚Äî ${percent}%`;
        qs('#progressBar').style.width = percent + '%';
    }

    function playNext(manual = false) {
        if (seqIndex >= sequence.length) {
            if (!qs('#textContent').textContent.includes(t('player.finished'))) {
                qs('#textContent').innerHTML += ` ‚úÖ ${t('player.finished')}.`;
            }
            updateProgress();
            audioEl.src = '';
            return;
        }
        const item = sequence[seqIndex];
        qs('#textContent').textContent = item.text || '‚Äî';
        const L1 = getL1();
        const spd1 = parseFloat(qs('#speed1').value);
        const spd2 = parseFloat(qs('#speed2').value);
        const spd = item.lang === L1 ? spd1 : spd2;
        const src = `{{ audio_path_prefix }}${item.file.replace(/^\.?\/*/,'')}`;
        audioEl.src = src;
        audioEl.playbackRate = spd;
        if (!manual) audioEl.play().catch(() => {});
        audioEl.onended = () => {
            seqIndex++;
            updateProgress();
            playNext();
        };
    }

    function playPrev() {
        if (seqIndex > 0) {
            seqIndex--;
            playNext(true);
        }
    }

    function playNextManual() {
        if (seqIndex < sequence.length - 1) {
            seqIndex++;
            playNext(true);
        }
    }

    async function startMode(mode) {
        currentMode = mode;
        if (activityInterval) clearInterval(activityInterval);
        logActivity(true);
        activityInterval = setInterval(logActivity, 15000); // Log every 15 seconds

        const langs = mode.includes('-') ? mode.split('-') : [mode];
        const transcripts = {{ transcripts|safe }};
        langData = transcripts;

        sequence = [];
        if (mode.includes('-')) {
            const [A, B] = mode.split('-');
            if (!langData[A] || !langData[B]) {
                console.error('Language data not found for mode:', mode);
                return;
            }
            const len = Math.max(langData[A].length, langData[B].length);
            for (let i = 0; i < len; i++) {
                if (langData[A][i]) sequence.push({ ...langData[A][i],
                    lang: A
                });
                if (langData[B][i]) sequence.push({ ...langData[B][i],
                    lang: B
                });
            }
        } else {
            sequence = langData[mode].map(x => ({ ...x,
                lang: mode
            }));
        }
        seqIndex = 0;
        playNext();
    }

    function buildModes() {
        const L1 = getL1();
        const L2 = getL2();
        const buttons = [];
        if (L1) buttons.push(L1);
        if (L1 && L2 && L2 !== '' && L2 !== L1) {
            buttons.push(`${L1}-${L2}`, `${L2}-${L1}`, L2);
        }
        const modeButtons = qs('#modeButtons');
        const titleEl = qs('#modesTitle');
        modeButtons.innerHTML = buttons.map(m => `<button data-mode="${m}">${m}</button>`).join('');
        titleEl.style.display = buttons.length > 1 ? 'block' : 'none';
        qsa('#modeButtons button').forEach(b => b.onclick = () => startMode(b.dataset.mode));
    }

    function disableSameLang() {
        const l1 = getL1();
        qsa('input[name="l2"]').forEach(r => {
            r.disabled = (r.value && r.value === l1);
            if (r.checked && r.disabled) {
                const none = qs('input[name="l2"][value=""]');
                if (none) none.checked = true;
            }
        });
        buildModes();
    }

    async function buildLangRadios() {
        await loadTranslations();
        const L1 = radiosMarkup(availableLangs, 'l1', false);
        const L2 = `<label><input type="radio" name="l2" value="" checked> ${t('player.none')}</label>` + radiosMarkup(availableLangs, 'l2', false);
        qs('#radiosL1').innerHTML = L1;
        qs('#radiosL2').innerHTML = L2;

        qsa('input[name="l1"]').forEach(r => r.onchange = disableSameLang);
        qsa('input[name="l2"]').forEach(r => r.onchange = buildModes);

        disableSameLang();
    }

    buildLangRadios();

    qs('#prevBtn').onclick = () => playPrev();
    qs('#nextBtn').onclick = () => playNextManual();

    window.addEventListener('beforeunload', () => {
        logActivity();
    });
});
</script>
{% endblock %}

{% block content %}
  <section id="topInfo" class="topCard">
    <img id="relatImg" src="{% static 'imgs/book-icon.png' %}" alt="Imatge relat"/>
    <div>
      <h2 id="relatTitle">{{ title.human_title }}</h2>
      <div id="relatDesc" style="margin:.1em 0 .3em 0;">{{ title.description }}</div>
      <div class="langs">üåê <span data-translate-key="player.languages">Idiomes:</span> <span id="relatLangs">
        {{ title.languages|join:", " }}
      </span></div>
    </div>
  </section>

  <section id="setupPanel" class="panel-soft">
    <div class="row">
      <div class="langBox">
        <strong data-translate-key="player.first_language">Primera llengua</strong>
        <div id="radiosL1" class="radios"></div>
        <label style="margin-top:.6em"><span data-translate-key="player.speed1">Velocitat 1:</span>
          <select id="speed1"><option>0.5</option><option>0.7</option><option>0.8</option><option>0.9</option><option selected>1.0</option><option>1.1</option><option>1.2</option><option>1.5</option><option>2</option></select>
        </label>
      </div>
      <div class="langBox">
        <strong data-translate-key="player.second_language">Segona llengua (opcional)</strong>
        <div id="radiosL2" class="radios"></div>
        <label style="margin-top:.6em"><span data-translate-key="player.speed2">Velocitat 2:</span>
          <select id="speed2"><option>0.5</option><option>0.7</option><option>0.8</option><option>0.9</option><option selected>1.0</option><option>1.1</option><option>1.2</option><option>1.5</option><option>2</option></select>
        </label>
      </div>
    </div>
  </section>

  <section id="modesPanel" style="text-align:center;margin:1em 0;">
    <div id="modesTitle" data-translate-key="player.listening_modes">üåê Modes d‚Äôescolta</div>
    <div id="modeButtons"></div>
  </section>

  <section id="playerPanel" class="panel">
    <div id="textBox">
      <div id="progressInfo"></div>
      <div id="textContent"></div>
      <div id="progressBarContainer"><div id="progressBar"></div></div>
    </div>
    <div style="display:flex;align-items:center;justify-content:center;gap:.8em;margin:.6em 0;">
      <button id="prevBtn">‚èÆÔ∏è</button>
      <audio id="audio" controls></audio>
      <button id="nextBtn">‚è≠Ô∏è</button>
    </div>
    <a id="backBtn" href="{% url 'products:catalog' %}" class="button">‚¨ÖÔ∏è <span data-translate-key="player.back_to_catalog">Torna al cat√†leg</span></a>
  </section>
{% endblock %}
