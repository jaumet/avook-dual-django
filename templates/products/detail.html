{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load l10n %}
{% load product_tags %}

{% get_product_translation product request.LANGUAGE_CODE as product_translation %}

{% block title %}
    {% if product_translation %}{{ product_translation.name }}{% else %}{{ product.machine_name }}{% endif %} — Audiovook Dual
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/product_detail.css' %}">
{% endblock %}

{% block content %}
<section class="product-detail">
    <div class="product-detail__header">
        <div class="product-detail__media">
            <img src="{% static 'imgs/mockup_portada.png' %}" alt="{% if product_translation %}{{ product_translation.name }}{% else %}{{ product.machine_name }}{% endif %}" />
        </div>
        <div>
            <h1>{% if product_translation %}{{ product_translation.name }}{% else %}{{ product.machine_name }}{% endif %}</h1>
            <p class="lead">{% if product_translation %}{{ product_translation.description }}{% else %}{% trans "La descripció no està disponible." %}{% endif %}</p>
            <div class="product-detail__meta">
                <p class="price">{% trans "Preu:" %} {{ product.price }} €</p>
                <p>{% trans "Durada:" %} {{ product.duration }} {% trans "mesos" %}</p>
            </div>
             {% if user.is_authenticated and user.is_staff %}
                <a class="button button--small" href="{% url 'products:product_update' product.pk %}">{% trans "Editar producte" %}</a>
            {% endif %}
        </div>
    </div>

{% load content_tags %}
    <div class="product-detail__legal">
        <h2>{% trans "Condicions de venda" %}</h2>
        <div class="scrollable-div">
            {% get_translatable_content 'product_terms' as sales_conditions %}
            {{ sales_conditions|safe }}
        </div>
    </div>

    <div class="product-detail__purchase">
        {% if user.is_authenticated %}
            <div class="form-check">
                <input type="checkbox" id="accept-conditions" class="form--input">
                <label for="accept-conditions" class="form-check-label">{% trans "Accepto les condicions de venda" %}</label>
            </div>
            <button id="buy-button" class="button button--primary">{% trans "Comprar ara" %}</button>
            <div id="buy-button-container"></div>
        {% else %}
            <div class="my-3">
                <a href="{% url 'accounts:login' %}" class="button button--primary">{% trans "Inicia sessió per comprar" %}</a>
                <p class="mt-2"><small>{% trans "Per comprar productes, cal que hagis iniciat sessió o que t'hagis registrat a Dual.cat" %}</small></p>
            </div>
        {% endif %}
    </div>

    {% for package in product.packages.all %}
    <div class="product-detail__titles">
        <h2>{% trans "Títols inclosos en el paquet:" %} {{ package.name }}</h2>
        {% if package.titles.all %}
            <ul>
                {% for title in package.titles.all %}
                    <li class="product-detail__title-item">
                        <div>
                            <p class="kicker">{% trans "Nivell" %} {{ title.level }}</p>
                            <strong>{{ title.machine_name }}</strong>
                        </div>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>{% trans "Encara no hi ha títols assignats a aquest paquet." %}</p>
        {% endif %}
    </div>
    {% endfor %}
</section>
{% endblock %}

{% block extra_js %}
    {% if user.is_authenticated %}
        <script src="{% static 'js/paypal_buttons.js' %}"></script>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const acceptConditions = document.getElementById('accept-conditions');
            const buyButton = document.getElementById('buy-button');
            const buyButtonContainer = document.getElementById('buy-button-container');

            if (acceptConditions) {
                acceptConditions.addEventListener('change', function() {
                    if (this.checked) {
                        buyButton.style.display = 'none';
                        buyButtonContainer.style.display = 'block';
                        if (typeof renderLinkButton === 'function') {
                            renderLinkButton(
                                '#buy-button-container',
                                '{% if product_translation %}{{ product_translation.name|escapejs }}{% else %}{{ product.machine_name|escapejs }}{% endif %}',
                                '{{ product.price|unlocalize|escapejs }}',
                                '{{ product.machine_name|escapejs }}',
                                '{% url "products:success" %}',
                                '{{ user.id|escapejs }}',
                                '{{ product.id|escapejs }}'
                            );
                        }
                    } else {
                        buyButton.style.display = 'block';
                        buyButtonContainer.style.display = 'none';
                        buyButtonContainer.innerHTML = '';
                    }
                });
            }
        });
        </script>
    {% endif %}
{% endblock %}
